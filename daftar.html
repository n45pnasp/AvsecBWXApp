<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Daftar Akun</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#16a34a; }
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body {
      margin:0; background:linear-gradient(180deg,#0b1220,#0f172a);
      color:var(--text); display:grid; place-items:center; min-height:100vh; padding:20px;
    }
    .card { background:rgba(17,24,39,.85); border:1px solid rgba(148,163,184,.15); border-radius:18px; padding:24px; max-width:420px; width:100%; }
    h1 { margin:0 0 8px; font-size:26px; text-align:center; }
    p  { margin:0 0 18px; font-size:14px; color:var(--muted); text-align:center; }
    label { font-size:14px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select {
      width:100%; padding:12px; border-radius:10px; border:1px solid rgba(148,163,184,.25);
      background:#0b1220; color:var(--text); font-size:14px; margin-bottom:14px;
    }
    input:focus, select:focus { border-color:var(--accent); outline:none; }
    button {
      width:100%; padding:12px; border-radius:10px; border:none;
      background:var(--accent); color:#052e16; font-weight:600; cursor:pointer;
    }
    button[disabled]{ opacity:.7; cursor:wait; }
    button:hover:not([disabled]) { background:var(--accent-2); }
    .msg { margin-top:12px; font-size:14px; padding:10px; border-radius:8px; display:none; }
    .error { background:#7f1d1d; color:#fecaca; }
    .success { background:#14532d; color:#bbf7d0; }
    .small { text-align:center; font-size:12px; color:var(--muted); margin-top:8px; }
    .small a { color:#a7f3d0; text-decoration:none; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daftar</h1>
    <p>Isi <b>nama lengkap (tepat 2 kata)</b>, spesifikasi, tipe akun, email, dan kata sandi.</p>

    <form id="registerForm" novalidate>
      <label for="nama">Nama Lengkap (2 kata)</label>
      <input type="text" id="nama" placeholder="Contoh: Budi Santoso" required />

      <label for="spec">Spesifikasi</label>
      <select id="spec" required>
        <option value="" disabled selected>Pilih spesifikasi</option>
        <option value="basic">Basic</option>
        <option value="junior">Junior</option>
        <option value="senior">Senior</option>
      </select>

      <label for="role">Tipe Akun</label>
      <select id="role" required>
        <option value="user" selected>Non-Admin</option>
        <option value="admin">Admin</option>
      </select>

      <div id="adminWrap" class="hidden">
        <label for="adminCode">Kode Admin</label>
        <input type="password" id="adminCode" placeholder="Masukkan Kode Admin" />
      </div>

      <label for="email">Email</label>
      <input type="email" id="email" placeholder="nama@domain.com" required />

      <label for="password">Kata Sandi</label>
      <input type="password" id="password" placeholder="Minimal 6 karakter" minlength="6" required />

      <button id="submitBtn" type="submit">Daftar</button>
    </form>

    <div id="msgBox" class="msg"></div>
    <div class="small">Sudah punya akun? <a href="index.html">Masuk</a></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ====== KONFIG FIREBASE (RTDB URL ganti jika beda) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBc-kE-_q1yoENYECPTLC3EZf_GxBEwrWY",
      authDomain: "avsecbwx-4229c.firebaseapp.com",
      projectId: "avsecbwx-4229c",
      storageBucket: "avsecbwx-4229c.appspot.com",
      messagingSenderId: "1029406629258",
      appId: "1:1029406629258:web:53e8f09585cd77823efc73",
      measurementId: "G-P37F88HGFE",
      databaseURL: "https://avsecbwx-4229c-default-rtdb.firebaseio.com"
    };

    // ====== KODE ADMIN (RAHASIA) ======
    // Ganti dengan kode rahasia kamu. Idealnya simpan/validasi di server/Cloud Function.
    const ADMIN_CODE = "BWX-ADMIN-N45P";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const $ = (q)=>document.querySelector(q);
    const form = $("#registerForm");
    const namaEl = $("#nama");
    const specEl = $("#spec");
    const roleEl = $("#role");
    const adminWrap = $("#adminWrap");
    const adminCodeEl = $("#adminCode");
    const emailEl = $("#email");
    const passEl = $("#password");
    const msgBox = $("#msgBox");
    const submitBtn = $("#submitBtn");

    roleEl.addEventListener("change", ()=>{
      const wantAdmin = roleEl.value === "admin";
      adminWrap.classList.toggle("hidden", !wantAdmin);
      if (!wantAdmin) adminCodeEl.value = "";
    });

    const showMsg=(t,type="error")=>{msgBox.textContent=t;msgBox.className="msg "+type;msgBox.style.display="block";};
    const formatNama=(s)=>s.trim().split(/\s+/).map(k=>k[0]?.toUpperCase()+k.slice(1).toLowerCase()).join(" ");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); msgBox.style.display="none";
      let nama = namaEl.value.trim();
      const spec = specEl.value;
      const roleReq = roleEl.value; // "admin" | "user"
      const adminCode = adminCodeEl.value.trim();
      const email = emailEl.value.trim();
      const pass  = passEl.value;

      // Validasi nama: huruf semua bahasa + spasi/titik/apostrof/hyphen, HARUS tepat 2 kata
      const onlyLetters = /^[\p{L}\s.'-]+$/u.test(nama);
      const words = nama.split(/\s+/).filter(Boolean);
      if (!onlyLetters) return showMsg("Nama hanya boleh huruf dan spasi (boleh titik, apostrof, tanda hubung).");
      if (words.length < 2) return showMsg("Nama lengkap minimal 2 kata.");
      if (words.length > 2) return showMsg("Nama lengkap maksimal 2 kata.");
      if (!spec) return showMsg("Silakan pilih spesifikasi.");

      // Validasi admin code jika pilih admin
      let isAdmin = false;
      if (roleReq === "admin") {
        if (!adminCode) return showMsg("Kode Admin wajib diisi untuk membuat akun Admin.");
        if (adminCode !== ADMIN_CODE) {
          showMsg("Kode Admin salah. Akun akan dibuat sebagai Non-Admin.", "error");
          // Kita lanjutkan tetapi set sebagai Non-Admin
        } else {
          isAdmin = true;
        }
      }

      nama = formatNama(nama);
      submitBtn.disabled = true;

      try {
        // Buat user
        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // Set displayName di Auth
        await updateProfile(cred.user, { displayName: nama });

        // Simpan profil ke Realtime Database
        await set(ref(db, `users/${cred.user.uid}`), {
          name: nama,
          spec: spec,                    // basic | junior | senior
          role: isAdmin ? "admin" : "user",
          isAdmin: isAdmin,
          email: cred.user.email,
          createdAt: Date.now()
        });

        // Beri tahu Kodular (opsional)
        const payload = JSON.stringify({
          event: "register",
          status: "success",
          uid: cred.user.uid,
          email: cred.user.email,
          name: nama,
          spec: spec,
          role: isAdmin ? "admin" : "user",
          isAdmin: isAdmin,
          ts: Date.now()
        });
        if (window.AppInventor?.setWebViewString) window.AppInventor.setWebViewString(payload);

        showMsg(`Pendaftaran berhasil! Selamat datang, ${nama} [${spec}] ${isAdmin ? "(Admin)" : ""}.`, "success");
        setTimeout(()=>{ window.location.href = "index.html"; }, 1200);
      } catch (err) {
        const map = {
          "auth/email-already-in-use": "Email sudah terdaftar.",
          "auth/invalid-email": "Format email tidak valid.",
          "auth/weak-password": "Kata sandi minimal 6 karakter."
        };
        showMsg(map[err.code] || "Gagal daftar: " + err.message);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
