<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Daftar Akun Avsec BWX App</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#16a34a; --danger:#ef4444; }
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body {
      margin:0; background:linear-gradient(180deg,#0b1220,#0f172a);
      color:var(--text); display:grid; place-items:center; min-height:100vh; padding:20px;
    }
    .card { background:rgba(17,24,39,.85); border:1px solid rgba(148,163,184,.15); border-radius:18px; padding:24px; max-width:420px; width:100%; }
    h1 { margin:0 0 8px; font-size:26px; text-align:center; }
    p  { margin:0 18px 18px; font-size:14px; color:var(--muted); text-align:center; }
    label { font-size:14px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select {
      width:100%; padding:12px; border-radius:10px; border:1px solid rgba(148,163,184,.25);
      background:#0b1220; color:var(--text); font-size:14px; margin-bottom:14px;
    }
    input:focus, select:focus { border-color:var(--accent); outline:none; }
    .row-inline { display:flex; gap:8px; align-items:center; }
    .hint { font-size:12px; color:var(--muted); margin-top:-8px; margin-bottom:12px; }
    button {
      width:100%; padding:12px; border-radius:10px; border:none;
      background:var(--accent); color:#052e16; font-weight:600; cursor:pointer;
    }
    button[disabled]{ opacity:.7; cursor:wait; }
    button:hover:not([disabled]) { background:var(--accent-2); }
    .btn-ghost { background:transparent; border:1px solid rgba(148,163,184,.25); color:var(--text); }
    .file-chip {
      display:inline-flex; align-items:center; gap:8px; font-size:12px;
      padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); margin-top:-6px; margin-bottom:10px;
    }
    .file-chip img { width:18px; height:18px; border-radius:3px; object-fit:cover; display:none; }
    .file-chip.has-thumb img { display:block; }
    .msg { margin-top:12px; font-size:14px; padding:10px; border-radius:8px; display:none; }
    .error { background:#7f1d1d; color:#fecaca; }
    .success { background:#14532d; color:#bbf7d0; }
    .small { text-align:center; font-size:12px; color:var(--muted); margin-top:8px; }
    .small a { color:#a7f3d0; text-decoration:none; }

    /* Modal (popup) ala Google Form upload */
    .modal-backdrop {
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:50;
    }
    .modal-backdrop.show { display:grid; }
    .modal {
      width:min(92vw,420px); background:rgba(17,24,39,.98); border:1px solid rgba(148,163,184,.25);
      border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.45);
      animation:pop .2s ease-out both;
    }
    .modal h3 { margin:0 0 6px; font-size:18px; }
    .modal p  { margin:0 0 10px; color:var(--muted); font-size:13px; }
    .modal input[type=file] {
      width:100%; padding:10px; border-radius:10px; border:1px dashed rgba(148,163,184,.35); background:#0b1220;
    }
    .modal .actions { display:flex; gap:8px; margin-top:12px; }
    .bar{height:8px;background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:8px;overflow:hidden;margin-top:10px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a)}
    .preview { margin-top:10px; display:none; }
    .preview img { max-width:100%; border-radius:12px; border:1px solid rgba(148,163,184,.15); }

    .overlay {
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:60;
    }
    .overlay.show { display:grid; }
    .spinner {
      width:54px; height:54px; border:5px solid rgba(255,255,255,.25); border-top-color:#22c55e; border-radius:50%;
      animation:spin 1s linear infinite;
    }

    @keyframes pop { from{opacity:.0; transform:translateY(6px) scale(.98)} to{opacity:1; transform:none} }
    @keyframes spin { to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daftar</h1>
    <p>Isi <b>nama lengkap (tepat 2 kata)</b>, spesifikasi, tipe akun, email, sandi, dan (opsional) upload foto.</p>

    <form id="registerForm" novalidate>
      <label for="nama">Nama Lengkap (2 kata)</label>
      <input type="text" id="nama" placeholder="Contoh: Budi Santoso" required />
      <div class="hint">Huruf & spasi saja (boleh titik, apostrof, tanda hubung). Tepat 2 kata.</div>

      <label for="spec">Spesifikasi</label>
      <select id="spec" required>
        <option value="" disabled selected>Pilih spesifikasi</option>
        <option value="basic">Basic</option>
        <option value="junior">Junior</option>
        <option value="senior">Senior</option>
      </select>

      <label for="role">Tipe Akun</label>
      <select id="role" required>
        <option value="user" selected>Non-Admin</option>
        <option value="admin">Admin</option>
      </select>

      <div id="adminWrap" class="hidden">
        <label for="adminCode">Kode Admin</label>
        <input type="password" id="adminCode" placeholder="Masukkan Kode Admin" />
      </div>

      <label>Foto (opsional)</label>
      <div class="row-inline">
        <button id="openUpload" type="button" class="btn-ghost" style="flex:1">Upload Foto…</button>
      </div>
      <div id="fileChip" class="file-chip" style="display:none">
        <img id="thumb" alt="thumb">
        <span id="fileName">file.jpg</span>
        <button id="clearFile" type="button" class="btn-ghost" style="padding:6px 10px">Hapus</button>
      </div>

      <label for="email">Email</label>
      <input type="email" id="email" placeholder="nama@domain.com" required />

      <label for="password">Kata Sandi</label>
      <input type="password" id="password" placeholder="Minimal 6 karakter" minlength="6" required />

      <button id="submitBtn" type="submit">Daftar</button>
    </form>

    <div id="msgBox" class="msg"></div>
    <div class="small">Sudah punya akun? <a href="index.html">Masuk</a></div>
  </div>

  <!-- Modal upload ala Google Form -->
  <div id="modalBack" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Unggah Foto</h3>
      <p>Pilih gambar (maks 5 MB). Unggahan terjadi setelah kamu menekan tombol <b>Daftar</b>.</p>
      <input id="file" type="file" accept="image/*" />
      <div class="preview"><img id="previewImg" alt="Preview" /></div>
      <div class="bar"><div id="fill" class="fill"></div></div>
      <div class="actions">
        <button id="saveFile" type="button">Simpan Pilihan</button>
        <button id="cancelFile" type="button" class="btn-ghost">Batal</button>
      </div>
      <div id="modalMsg" class="msg" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Overlay proses (register+upload) -->
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // ====== KONFIG FIREBASE ======
    const firebaseConfig = {
      apiKey: "AIzaSyBc-kE-_q1yoENYECPTLC3EZf_GxBEwrWY",
      authDomain: "avsecbwx-4229c.firebaseapp.com",
      projectId: "avsecbwx-4229c",
      storageBucket: "avsecbwx-4229c.appspot.com",
      messagingSenderId: "1029406629258",
      appId: "1:1029406629258:web:53e8f09585cd77823efc73",
      measurementId: "G-P37F88HGFE",
      databaseURL: "https://avsecbwx-4229c-default-rtdb.firebaseio.com"
    };

    const ADMIN_CODE = "BWX-ADMIN-N45P"; // ganti sesuai kebutuhan

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const stg  = getStorage(app);

    // EL
    const $ = (q)=>document.querySelector(q);
    const form = $("#registerForm");
    const namaEl = $("#nama");
    const specEl = $("#spec");
    const roleEl = $("#role");
    const adminWrap = $("#adminWrap");
    const adminCodeEl = $("#adminCode");
    const emailEl = $("#email");
    const passEl = $("#password");
    const submitBtn = $("#submitBtn");
    const msgBox = $("#msgBox");

    const openUpload = $("#openUpload");
    const fileChip = $("#fileChip");
    const fileNameEl = $("#fileName");
    const clearFileBtn = $("#clearFile");
    const thumb = $("#thumb");

    const modalBack = $("#modalBack");
    const fileEl = $("#file");
    const saveFile = $("#saveFile");
    const cancelFile = $("#cancelFile");
    const modalMsg = $("#modalMsg");
    const previewBox = document.querySelector(".preview");
    const previewImg = $("#previewImg");
    const fill = $("#fill");

    const overlay = $("#overlay");

    let selectedFile = null;      // File yang dipilih di modal (belum diupload)
    let selectedThumbURL = "";    // ObjectURL untuk preview/thumbnail

    const showMsg=(t,type="error")=>{ msgBox.textContent=t; msgBox.className="msg "+type; msgBox.style.display="block"; };
    const showModalMsg=(t,type="error")=>{ modalMsg.textContent=t; modalMsg.className="msg "+type; modalMsg.style.display="block"; };
    const formatNama=(s)=>s.trim().split(/\s+/).map(k=>k[0]?.toUpperCase()+k.slice(1).toLowerCase()).join(" ");

    roleEl.addEventListener("change", ()=>{
      const wantAdmin = roleEl.value === "admin";
      adminWrap.classList.toggle("hidden", !wantAdmin);
      if (!wantAdmin) adminCodeEl.value = "";
    });

    // ===== Popup upload =====
    openUpload.addEventListener("click", ()=>{
      modalMsg.style.display="none";
      previewBox.style.display = selectedFile ? "block" : "none";
      if (selectedFile && selectedThumbURL) previewImg.src = selectedThumbURL;
      fill.style.width = "0%";
      fileEl.value = "";
      modalBack.classList.add("show");
      modalBack.setAttribute("aria-hidden","false");
    });
    cancelFile.addEventListener("click", ()=>{
      modalBack.classList.remove("show");
      modalBack.setAttribute("aria-hidden","true");
    });

    fileEl.addEventListener("change", ()=>{
      const f = fileEl.files?.[0];
      modalMsg.style.display="none";
      if (!f) { previewBox.style.display="none"; return; }
      if (!/^image\//.test(f.type)) { showModalMsg("File harus gambar.", "error"); fileEl.value=""; return; }
      const max = 5 * 1024 * 1024;
      if (f.size > max) { showModalMsg("Ukuran maksimal 5 MB.", "error"); fileEl.value=""; return; }
      selectedFile = f;
      if (selectedThumbURL) URL.revokeObjectURL(selectedThumbURL);
      selectedThumbURL = URL.createObjectURL(f);
      previewImg.src = selectedThumbURL;
      previewBox.style.display = "block";
    });

    saveFile.addEventListener("click", ()=>{
      if (!selectedFile) { showModalMsg("Belum ada file dipilih.", "error"); return; }
      // tampilkan chip ringkas di form
      fileNameEl.textContent = selectedFile.name;
      if (selectedThumbURL) { thumb.src = selectedThumbURL; fileChip.classList.add("has-thumb"); }
      fileChip.style.display = "inline-flex";
      modalBack.classList.remove("show");
      modalBack.setAttribute("aria-hidden","true");
    });

    clearFileBtn.addEventListener("click", ()=>{
      selectedFile = null;
      if (selectedThumbURL) { URL.revokeObjectURL(selectedThumbURL); selectedThumbURL=""; }
      fileChip.style.display = "none";
      fileChip.classList.remove("has-thumb");
    });

    // ===== Validasi & Submit =====
    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); msgBox.style.display="none";

      let nama = namaEl.value.trim();
      const spec = specEl.value;
      const roleReq = roleEl.value; // "admin" | "user"
      const adminCode = adminCodeEl.value.trim();
      const email = emailEl.value.trim();
      const pass  = passEl.value;

      // Validasi nama: huruf semua bahasa + spasi/titik/apostrof/hyphen, HARUS tepat 2 kata
      const onlyLetters = /^[\p{L}\s.'-]+$/u.test(nama);
      const words = nama.split(/\s+/).filter(Boolean);
      if (!onlyLetters) return showMsg("Nama hanya boleh huruf dan spasi (boleh titik, apostrof, tanda hubung).");
      if (words.length < 2) return showMsg("Nama lengkap minimal 2 kata.");
      if (words.length > 2) return showMsg("Nama lengkap maksimal 2 kata.");
      if (!spec) return showMsg("Silakan pilih spesifikasi.");

      // Validasi admin code jika pilih admin
      let isAdmin = false;
      if (roleReq === "admin") {
        if (!adminCode) return showMsg("Kode Admin wajib diisi untuk membuat akun Admin.");
        if (adminCode !== ADMIN_CODE) {
          showMsg("Kode Admin salah. Akun akan dibuat sebagai Non-Admin.", "error");
          // lanjut tapi set Non-Admin
        } else {
          isAdmin = true;
        }
      }

      nama = formatNama(nama);

      submitBtn.disabled = true;
      overlay.classList.add("show");

      let photoURL = null;
      try {
        // 1) Buat user
        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // 2) Set displayName
        await updateProfile(cred.user, { displayName: nama });

        // 3) Jika ada file terpilih → upload ke Storage (setelah user ada)
        if (selectedFile) {
          const safeName = selectedFile.name.replace(/[^\w.\-]+/g, "_");
          const path = `user_uploads/${cred.user.uid}/${Date.now()}-${safeName}`;
          const storageRef = sRef(stg, path);
          const task = uploadBytesResumable(storageRef, selectedFile, { contentType: selectedFile.type });

          // progress bar di modal (biar kelihatan kalau masih terbuka)
          task.on("state_changed", (snap)=>{
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            fill.style.width = pct + "%";
          });

          await task;
          photoURL = await getDownloadURL(storageRef);

          try { await updateProfile(cred.user, { photoURL }); } catch(_) {}
        }

        // 4) Simpan profil ke RTDB
        await set(ref(db, `users/${cred.user.uid}`), {
          name: nama,
          spec: spec,                    // basic | junior | senior
          role: isAdmin ? "admin" : "user",
          isAdmin: isAdmin,
          email: cred.user.email,
          photoURL: photoURL || null,    // simpan URL foto kalau ada
          createdAt: Date.now()
        });

        // 5) Beri tahu Kodular
        const payload = JSON.stringify({
          event: "register",
          status: "success",
          uid: cred.user.uid,
          email: cred.user.email,
          name: nama,
          spec: spec,
          role: isAdmin ? "admin" : "user",
          isAdmin: isAdmin,
          photoURL: photoURL,            // bisa null jika tidak upload
          ts: Date.now()
        });
        if (window.AppInventor?.setWebViewString) window.AppInventor.setWebViewString(payload);

        showMsg(`Pendaftaran berhasil! Selamat datang, ${nama} [${spec}] ${isAdmin ? "(Admin)" : ""}.`, "success");

        // 6) Pindah ke halaman login
        setTimeout(()=>{ window.location.href = "index.html"; }, 1200);
      } catch (err) {
        const map = {
          "auth/email-already-in-use": "Email sudah terdaftar.",
          "auth/invalid-email": "Format email tidak valid.",
          "auth/weak-password": "Kata sandi minimal 6 karakter."
        };
        showMsg(map[err.code] || "Gagal daftar: " + err.message);
      } finally {
        submitBtn.disabled = false;
        overlay.classList.remove("show");
      }
    });
  </script>
</body>
</html>
