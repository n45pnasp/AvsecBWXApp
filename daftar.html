<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Daftar Akun AVSEC BWX App</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#16a34a; --danger:#ef4444; }
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { margin:0; background:linear-gradient(180deg,#0b1220,#0f172a); color:var(--text); display:grid; place-items:center; min-height:100vh; padding:20px; }
    .card { background:rgba(17,24,39,.85); border:1px solid rgba(148,163,184,.15); border-radius:18px; padding:24px; max-width:420px; width:100%; }
    h1 { margin:0 0 8px; font-size:26px; text-align:center; }
    p  { margin:0 18px 18px; font-size:14px; color:var(--muted); text-align:center; }
    label { font-size:14px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(148,163,184,.25); background:#0b1220; color:var(--text); font-size:14px; margin-bottom:14px; }
    input:focus, select:focus { border-color:var(--accent); outline:none; }
    .row-inline { display:flex; gap:8px; align-items:center; }
    .hint { font-size:12px; color:var(--muted); margin-top:-8px; margin-bottom:12px; }
    button { width:100%; padding:12px; border-radius:10px; border:none; background:var(--accent); color:#052e16; font-weight:600; cursor:pointer; }
    button[disabled]{ opacity:.7; cursor:wait; }
    button:hover:not([disabled]) { background:var(--accent-2); }
    .btn-ghost { background:transparent; border:1px solid rgba(148,163,184,.25); color:var(--text); }
    .file-chip { display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); margin-top:-6px; margin-bottom:10px; }
    .file-chip img { width:18px; height:18px; border-radius:3px; object-fit:cover; display:none; }
    .file-chip.has-thumb img { display:block; }
    .msg { margin-top:12px; font-size:14px; padding:10px; border-radius:8px; display:none; }
    .error { background:#7f1d1d; color:#fecaca; }
    .success { background:#14532d; color:#bbf7d0; }
    .small { text-align:center; font-size:12px; color:var(--muted); margin-top:8px; }
    .small a { color:#a7f3d0; text-decoration:none; }
    .hidden { display:none; }

    .modal-backdrop { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:50; }
    .modal-backdrop.show { display:grid; }
    .modal { width:min(92vw, 360px); background:rgba(17,24,39,.98); border:1px solid rgba(148,163,184,.25); border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.45); animation:pop .2s ease-out both; }
    .modal h3 { margin:0 0 6px; font-size:16px; }
    .modal p  { margin:0 0 10px; color:var(--muted); font-size:12px; }
    .modal input[type=file] { width:100%; padding:10px; border-radius:10px; border:1px dashed rgba(148,163,184,.35); background:#0b1220; color:var(--text); }
    .modal .actions { display:flex; gap:8px; margin-top:10px; }
    .bar{height:8px;background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:8px;overflow:hidden;margin-top:10px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a)}
    .fill.indet{ animation:indet 1.2s linear infinite; }
    .preview { margin-top:10px; display:none; }
    .preview img { max-width:100%; max-height:42vh; object-fit:contain; border-radius:12px; border:1px solid rgba(148,163,184,.15); }
    @keyframes pop { from{opacity:.0; transform:translateY(6px) scale(.98)} to{opacity:1; transform:none} }
    @keyframes indet { 0%{width:5%} 50%{width:85%} 100%{width:5%} }
    @media (min-width: 768px){ .modal { width:min(80vw, 380px); } }

    .overlay { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:60; }
    .overlay.show { display:grid; }
    .spinner { width:54px; height:54px; border:5px solid rgba(255,255,255,.25); border-top-color:#22c55e; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daftar</h1>
    <p>Isi <b>nama lengkap (tepat 2 kata)</b>, spesifikasi, tipe akun, email, sandi, dan <b>wajib</b> upload foto.</p>

    <form id="registerForm" novalidate>
      <label for="nama">Nama Lengkap (2 kata)</label>
      <input type="text" id="nama" placeholder="Contoh: Budi Santoso" required />
      <div class="hint">Huruf & spasi saja (boleh titik, apostrof, tanda hubung). Tepat 2 kata.</div>

      <label for="spec">Spesifikasi</label>
      <select id="spec" required>
        <option value="" disabled selected>Pilih spesifikasi</option>
        <option value="basic">Basic</option>
        <option value="junior">Junior</option>
        <option value="senior">Senior</option>
      </select>

      <label for="role">Tipe Akun</label>
      <select id="role" required>
        <option value="user" selected>Non-Admin</option>
        <option value="admin">Admin</option>
      </select>

      <div id="adminWrap" class="hidden">
        <label for="adminCode">Kode Admin</label>
        <input type="password" id="adminCode" placeholder="Masukkan Kode Admin" />
      </div>

      <label>Foto (<b>wajib</b>)</label>
      <div class="row-inline">
        <button id="openUpload" type="button" class="btn-ghost" style="flex:1">Upload Foto…</button>
      </div>
      <div id="fileChip" class="file-chip" style="display:none">
        <img id="thumb" alt="thumb">
        <span id="fileName">file.jpg</span>
        <button id="clearFile" type="button" class="btn-ghost" style="padding:6px 10px">Hapus</button>
      </div>

      <label for="email">Email</label>
      <input type="email" id="email" placeholder="nama@domain.com" required />

      <label for="password">Kata Sandi</label>
      <input type="password" id="password" placeholder="Minimal 6 karakter" minlength="6" required />

      <button id="submitBtn" type="submit" disabled>Daftar</button>
      <div class="hint">Tombol Daftar aktif setelah foto berhasil diupload & disimpan.</div>
    </form>

    <div id="msgBox" class="msg"></div>
    <div class="small">Sudah punya akun? <a href="index.html">Masuk</a></div>
  </div>

  <!-- Modal upload -->
  <div id="modalBack" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Unggah Foto</h3>
      <p>Pilih gambar (maks 5 MB). Setelah dipilih, upload akan berjalan dan progress terlihat di bawah.</p>

      <input id="file" type="file" accept="image/*" />
      <div class="preview"><img id="previewImg" alt="Preview" /></div>
      <div class="bar"><div id="fill" class="fill"></div></div>

      <div class="actions">
        <button id="saveFile" type="button" disabled>Simpan Pilihan</button>
        <button id="cancelFile" type="button" class="btn-ghost">Batal</button>
      </div>
      <div id="modalMsg" class="msg" style="margin-top:10px"></div>
    </div>
  </div>

  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, updateProfile
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase (Auth + RTDB)
    const firebaseConfig = {
      apiKey: "AIzaSyBc-kE-_q1yoENYECPTLC3EZf_GxBEwrWY",
      authDomain: "avsecbwx-4229c.firebaseapp.com",
      projectId: "avsecbwx-4229c",
      messagingSenderId: "1029406629258",
      appId: "1:1029406629258:web:53e8f09585cd77823efc73",
      measurementId: "G-P37F88HGFE",
      databaseURL: "https://avsecbwx-4229c-default-rtdb.firebaseio.com"
    };

    // GAS & Folder Drive (punyamu)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbye3DxrOPeCS58sWdKQdEFXm9xfrTzLXIYAG0v5wFKwaqfSSyQXq_32RXszqJJOdRXgKQ/exec";
    const FOLDER_ID  = "1_bk5jcyq_3xkzWw69D64qPGHMd6yNba5";

    const ADMIN_CODE = "BWX-ADMIN";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // EL
    const $ = (q)=>document.querySelector(q);
    const form = $("#registerForm");
    const namaEl = $("#nama");
    const specEl = $("#spec");
    const roleEl = $("#role");
    const adminWrap = $("#adminWrap");
    const adminCodeEl = $("#adminCode");
    const emailEl = $("#email");
    const passEl = $("#password");
    const submitBtn = $("#submitBtn");
    const msgBox = $("#msgBox");

    const openUpload = $("#openUpload");
    const fileChip = $("#fileChip");
    const fileNameEl = $("#fileName");
    const clearFileBtn = $("#clearFile");
    const thumb = $("#thumb");

    const modalBack = $("#modalBack");
    const fileEl = $("#file");
    const saveFile = $("#saveFile");
    const cancelFile = $("#cancelFile");
    const modalMsg = $("#modalMsg");
    const previewBox = document.querySelector(".preview");
    const previewImg = $("#previewImg");
    const fill = $("#fill");
    const overlay = $("#overlay");

    let uploadedPhotoURL = null;
    let uploading = false;
    let lastFileId = null;

    const showMsg=(t,type="error")=>{ msgBox.textContent=t; msgBox.className="msg "+type; msgBox.style.display="block"; };
    const showModalMsg=(t,type="error")=>{ modalMsg.textContent=t; modalMsg.className="msg "+type; modalMsg.style.display="block"; };
    const formatNama=(s)=>s.trim().split(/\s+/).map(k=>k[0]?.toUpperCase()+k.slice(1).toLowerCase()).join(" ");

    // normalisasi nameLower yang stabil
    const normalizeNameLower = (s)=>
      s.trim().toLowerCase().replace(/\s+/g,' ');

    roleEl.addEventListener("change", ()=>{
      const wantAdmin = roleEl.value === "admin";
      adminWrap.classList.toggle("hidden", !wantAdmin);
      if (!wantAdmin) adminCodeEl.value = "";
    });

    // buka popup
    openUpload.addEventListener("click", ()=>{
      modalMsg.style.display="none";
      previewBox.style.display = "none";
      fill.classList.remove("indet"); fill.style.width="0%";
      fileEl.value = ""; saveFile.disabled = true; uploadedPhotoURL = null; lastFileId = null;

      modalBack.classList.add("show");
      modalBack.setAttribute("aria-hidden","false");
    });

    cancelFile.addEventListener("click", ()=>{
      if (uploading) return;
      modalBack.classList.remove("show");
      modalBack.setAttribute("aria-hidden","true");
    });

    // upload → GAS (boleh balas ID atau URL penuh)
    fileEl.addEventListener("change", ()=>{
      modalMsg.style.display="none";
      const f = fileEl.files?.[0];
      if (!f){ previewBox.style.display="none"; saveFile.disabled = true; return; }
      if (!/^image\//.test(f.type)){ showModalMsg("File harus gambar.", "error"); fileEl.value=""; return; }
      if (f.size > 5*1024*1024){ showModalMsg("Ukuran maksimal 5 MB.", "error"); fileEl.value=""; return; }

      previewBox.style.display = "block";
      const objURL = URL.createObjectURL(f);
      previewImg.src = objURL;

      const reader = new FileReader();
      reader.onprogress = (e)=>{
        if (e.lengthComputable){
          const pct = Math.round((e.loaded / e.total) * 100);
          fill.classList.remove("indet");
          fill.style.width = pct + "%";
        }
      };
      reader.onload = async (e)=>{
        const base64Data = String(e.target.result).split(",")[1];

        uploading = true;
        fill.classList.add("indet");
        saveFile.disabled = true;
        uploadedPhotoURL = null;
        lastFileId = null;

        const fd = new FormData();
        fd.append("action", "upload");
        fd.append("FILE", base64Data);
        fd.append("MIMETYPE", f.type);
        const safeName = `${Date.now()}-${f.name}`;
        fd.append("NAMA_FILE", safeName);
        fd.append("FOLDER_ID", FOLDER_ID);

        try{
          const res  = await fetch(SCRIPT_URL, { method:"POST", body: fd });
          const text = await res.text();
          const resText = (text || "").trim();

          // Terima ID atau URL penuh
          let urlFromServer = "";
          let idFromServer  = "";
          if (resText.startsWith("http")) {
            urlFromServer = resText;
            try { idFromServer = new URL(resText).searchParams.get("id") || ""; } catch(_) {}
          } else if (/^[A-Za-z0-9_-]{25,}$/.test(resText)) {
            idFromServer  = resText;
            urlFromServer = `https://drive.google.com/uc?export=view&id=${idFromServer}`;
          } else {
            uploadedPhotoURL = null; lastFileId = null;
            fill.classList.remove("indet"); fill.style.width = "0%";
            showModalMsg("Upload gagal: " + resText, "error");
            return;
          }

          lastFileId = idFromServer || "foto";
          uploadedPhotoURL = urlFromServer;
          fill.classList.remove("indet"); fill.style.width = "100%";
          saveFile.disabled = false;
          showModalMsg("Upload selesai. Klik 'Simpan Pilihan'.", "success");

        } catch(err){
          uploadedPhotoURL = null; lastFileId = null;
          fill.classList.remove("indet"); fill.style.width = "0%";
          showModalMsg("Error: " + (err.message || err), "error");
        } finally{
          uploading = false;
          URL.revokeObjectURL(objURL);
        }
      };
      reader.onerror = ()=> showModalMsg("Gagal membaca file.", "error");
      reader.readAsDataURL(f);
    });

    // simpan pilihan → tampil chip + aktifkan daftar
    saveFile.addEventListener("click", ()=>{
      if (!uploadedPhotoURL){ showModalMsg("Belum ada foto yang berhasil diupload.", "error"); return; }
      try { fileNameEl.textContent = lastFileId || (new URL(uploadedPhotoURL).searchParams.get("id") || "foto"); }
      catch { fileNameEl.textContent = lastFileId || "foto"; }
      thumb.src = uploadedPhotoURL;
      fileChip.classList.add("has-thumb");
      fileChip.style.display = "inline-flex";
      submitBtn.disabled = false;
      modalBack.classList.remove("show");
      modalBack.setAttribute("aria-hidden","true");
    });

    clearFileBtn.addEventListener("click", ()=>{
      uploadedPhotoURL = null; lastFileId = null;
      fileChip.style.display = "none"; fileChip.classList.remove("has-thumb");
      submitBtn.disabled = true;
    });

    // submit daftar → buat akun langsung (Auth), lalu tulis profil + indeks nameToUid
    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); msgBox.style.display="none";

      let nama = namaEl.value.trim();
      const spec = specEl.value;
      const roleReq = roleEl.value;
      const adminCode = (document.getElementById("adminCode")?.value || "").trim();
      const email = emailEl.value.trim();
      const pass  = passEl.value;

      const onlyLetters = /^[\p{L}\s.'-]+$/u.test(nama);
      const words = nama.split(/\s+/).filter(Boolean);
      if (!onlyLetters) return showMsg("Nama hanya boleh huruf dan spasi (boleh titik, apostrof, tanda hubung).");
      if (words.length < 2) return showMsg("Nama lengkap minimal 2 kata.");
      if (words.length > 2) return showMsg("Nama lengkap maksimal 2 kata.");
      if (!spec) return showMsg("Silakan pilih spesifikasi.");
      if (!uploadedPhotoURL) return showMsg("Foto profil wajib diunggah & disimpan dulu.");

      let isAdmin = false;
      if (roleReq === "admin") {
        if (!adminCode) return showMsg("Kode Admin wajib diisi untuk membuat akun Admin.");
        if (adminCode !== ADMIN_CODE) showMsg("Kode Admin salah. Akun akan dibuat sebagai Non-Admin.");
        else isAdmin = true;
      }

      nama = formatNama(nama);
      const nameLower = normalizeNameLower(nama);

      submitBtn.disabled = true; overlay.classList.add("show");

      try{
        // 1) Buat akun Auth
        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // 2) Update profile di Auth (optional, untuk display di app)
        await updateProfile(cred.user, { displayName: nama, photoURL: uploadedPhotoURL });

        // 3) Tulis profil ke RTDB (sesuai rule: hanya users/<uid> sendiri)
        await set(ref(db, `users/${cred.user.uid}`), {
          name: nama,
          nameLower,              // diperlukan untuk index/pencarian
          spec,                   // "basic" | "junior" | "senior"
          role: isAdmin ? "admin" : "user",
          isAdmin,
          email: cred.user.email,
          photoURL: uploadedPhotoURL,
          createdAt: Date.now()
        });

        // 4) Tulis indeks nameToUid → membutuhkan rule yang mengizinkan user menulis daunnya sendiri
        try{
          await set(ref(db, `nameToUid/${nameLower}/${cred.user.uid}`), true);
        } catch (idxErr){
          // Jika rule tidak mengizinkan, jangan blokir pendaftaran.
          console.warn("Gagal tulis nameToUid:", idxErr);
        }

        // notifikasi ke Kodular (opsional)
        const payload = JSON.stringify({
          event:"register", status:"success", uid:cred.user.uid, email:cred.user.email,
          name:nama, nameLower, spec, role:isAdmin?"admin":"user", isAdmin, photoURL:uploadedPhotoURL, ts:Date.now()
        });
        if (window.AppInventor?.setWebViewString) window.AppInventor.setWebViewString(payload);

        showMsg(`Pendaftaran berhasil! Selamat datang, ${nama} [${spec}] ${isAdmin ? "(Admin)" : ""}.`, "success");
        setTimeout(()=>{ window.location.href = "index.html"; }, 1200);

      } catch(err){
        const map = {
          "auth/email-already-in-use":"Email sudah terdaftar.",
          "auth/invalid-email":"Format email tidak valid.",
          "auth/weak-password":"Kata sandi minimal 6 karakter.",
          "auth/operation-not-allowed":"Aktifkan Email/Password di Authentication → Sign-in method."
        };
        showMsg(map[err.code] || ("Gagal daftar: " + (err.message || err)));
      } finally{
        submitBtn.disabled = false; overlay.classList.remove("show");
      }
    });
  </script>
</body>
</html>
