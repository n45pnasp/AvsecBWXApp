<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  // ==== KONFIG FIREBASE (punyamu) ====
  const firebaseConfig = {
    apiKey: "AIzaSyBc-kE-_q1yoENYECPTLC3EZf_GxBEwrWY",
    authDomain: "avsecbwx-4229c.firebaseapp.com",
    databaseURL: "https://avsecbwx-4229c-default-rtdb.firebaseio.com",
    projectId: "avsecbwx-4229c",
    storageBucket: "avsecbwx-4229c.firebasestorage.app",
    messagingSenderId: "1029406629258",
    appId: "1:1029406629258:web:53e8f09585cd77823efc73",
    measurementId: "G-P37F88HGFE"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // ==== PARAM URL ====
  const params = new URLSearchParams(location.search);
  const title = params.get('title') || 'Viewer SOP';
  const key   = params.get('key') || "";   // pakai DriveKey (jalur aman)
  const src   = params.get('src') || "";   // fallback publik (jika ada)
  const frame = document.getElementById('pdfFrame');
  document.getElementById('docTitle').textContent = title;

  // ==== URL Cloud Function drivePdf (punyamu) ====
  // region default dari index.js: us-central1
  const DRIVE_PDF_URL = "https://us-central1-avsecbwx-4229c.cloudfunctions.net/drivePdf";

  // ==== Util ====
  function isSafeURL(u) {
    try { const x = new URL(u, location.href); return /^https?:$/i.test(x.protocol); }
    catch { return false; }
  }
  function showDoc(html) {
    frame.srcdoc = `<!doctype html><meta charset="utf-8"><body style="background:#0b141a;color:#e9edef;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100%;text-align:center;padding:16px;">${html}</body>`;
  }

  // ==== Alur ====
  onAuthStateChanged(auth, async (u) => {
    if (!u) { location.href = "./login.html"; return; }

    try {
      if (key) {
        // Ambil idToken, fetch PDF sebagai blob via Cloud Function, tampilkan di iframe
        const idToken = await u.getIdToken(true);
        const url = `${DRIVE_PDF_URL}?key=${encodeURIComponent(key)}`;
        const res = await fetch(url, { headers: { Authorization: `Bearer ${idToken}` } });
        if (!res.ok) {
          const msg = await res.text().catch(()=>"");
          showDoc(`<div><h3>Gagal memuat PDF</h3><p>${res.status} ${msg}</p><p><a href="chatbot.html" style="color:#06cf9c;text-decoration:none;">Kembali</a></p></div>`);
          return;
        }
        const blob = await res.blob();
        frame.src = URL.createObjectURL(blob);
      } else if (isSafeURL(src)) {
        // Fallback: jika masih pakai URL publik dari kolom "Isi SOP"
        frame.src = src;
      } else {
        showDoc(`<div><h3>PDF tidak tersedia</h3><p>Param <code>key</code> kosong dan <code>src</code> tidak valid.</p><p><a href="chatbot.html" style="color:#06cf9c;text-decoration:none;">Kembali</a></p></div>`);
      }
    } catch (e) {
      showDoc(`<div><h3>Terjadi kesalahan</h3><p>${String(e.message || e)}</p><p><a href="chatbot.html" style="color:#06cf9c;text-decoration:none;">Kembali</a></p></div>`);
    }
  });

  // ====== Proteksi ringan (best effort) ======
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("dragstart", e => e.preventDefault());
  document.addEventListener("keydown", e => {
    const k = e.key.toLowerCase(), ctrl = e.ctrlKey || e.metaKey;
    if (k === 'f12' || (ctrl && (k === 's' || k === 'p' || k === 'u' || k === 'c')) || (ctrl && e.shiftKey && (k === 'i' || k === 'j'))) {
      e.preventDefault(); e.stopPropagation();
    }
  }, { capture: true });
  document.addEventListener('selectstart', e => e.preventDefault(), { capture: true });

  const STRICT_VIEW_ONLY = false;
  if (STRICT_VIEW_ONLY) document.getElementById('noInteract').style.display = 'block';
</script>
