<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <!-- IZINKAN ZOOM BROWSER -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=yes" />
  <title>Viewer SOP</title>
  <link rel="stylesheet" href="chatbot.css" />
  <style>
    .viewer-header{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--panel,#111b21);border-bottom:1px solid var(--border,#2a3942);height:56px;display:flex;align-items:center;gap:10px;padding:0 12px;color:var(--text,#e9edef);font-weight:600}
    .viewer-header .back-btn{width:44px;height:44px;margin-right:2px}
    .viewer-header .back-btn svg{width:26px;height:26px;stroke:currentColor}
    .title{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .viewer-wrap{position:fixed;top:56px;bottom:0;left:0;right:0;background:var(--bg,#0b141a)}
    .viewer-frame{width:100%;height:100%;border:0;background:#000}

    /* pdf.js container (mobile) */
    .pdf-root{position:absolute;inset:0;overflow:auto;background:#000;padding:8px}
    .pdf-page{display:block;margin:8px auto;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.35)}

    /* Loading */
    .loading{position:fixed;left:0;right:0;top:56px;bottom:0;z-index:150;background:rgba(11,20,26,.92);display:grid;place-items:center;backdrop-filter:blur(2px)}
    .loading[hidden]{display:none}
    .loading .box{text-align:center;color:#e9edef;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .spinner{width:48px;height:48px;margin:0 auto 12px;border:4px solid rgba(255,255,255,.25);border-top-color:#06cf9c;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ZOOM TOOLBAR (mobile) */
    .zoombar{position:fixed;right:10px;bottom:10px;z-index:160;background:rgba(17,27,33,.85);border:1px solid #2a3942;border-radius:14px;backdrop-filter:blur(4px);display:flex;align-items:center;gap:6px;padding:6px 8px}
    .zoombar[hidden]{display:none}
    .zoombar button{appearance:none;border:1px solid #2a3942;background:#0b141a;color:#e9edef;border-radius:10px;padding:6px 10px;font-size:14px}
    .zoombar .pct{min-width:56px;text-align:center;font-variant-numeric:tabular-nums;color:#06cf9c}

    body{-webkit-user-select:none;user-select:none}
    *{-webkit-touch-callout:none}
  </style>
</head>
<body>
  <div class="viewer-header" role="banner">
    <a class="back-btn" aria-label="Kembali ke Chatbot" href="#" onclick="safeBackTo('chatbot.html');return false;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </a>
    <div class="title" id="docTitle">Viewer SOP</div>
  </div>

  <div class="viewer-wrap">
    <!-- Desktop viewer -->
    <iframe id="pdfFrame" class="viewer-frame" src="about:blank" allow="fullscreen"></iframe>
    <!-- Mobile viewer (pdf.js) -->
    <div id="pdfRoot" class="pdf-root" hidden></div>

    <!-- Loader -->
    <div id="loading" class="loading" aria-live="polite">
      <div class="box"><div class="spinner"></div><div id="loadingMsg">Memuat dokumen…</div></div>
    </div>

    <!-- ZOOM BAR (mobile) -->
    <div id="zoomBar" class="zoombar" hidden>
      <button id="zoomOut" aria-label="Perkecil">–</button>
      <div class="pct" id="zoomPct">100%</div>
      <button id="zoomIn" aria-label="Perbesar">+</button>
      <button id="zoomFit" aria-label="Pas Lebar">Fit</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyBc-kE-_q1yoENYECPTLC3EZf_GxBEwrWY",
      authDomain: "avsecbwx-4229c.firebaseapp.com",
      databaseURL: "https://avsecbwx-4229c-default-rtdb.firebaseio.com",
      projectId: "avsecbwx-4229c",
      storageBucket: "avsecbwx-4229c.firebasestorage.app",
      messagingSenderId: "1029406629258",
      appId: "1:1029406629258:web:53e8f09585cd77823efc73",
      measurementId: "G-P37F88HGFE"
    };
    initializeApp(firebaseConfig);
    const auth = getAuth();

    // PARAMS
    const params = new URLSearchParams(location.search);
    const title  = params.get('title') || 'Viewer SOP';
    const key    = params.get('key') || '';
    const src    = params.get('src') || '';

    // ELEMS
    const titleEl   = document.getElementById('docTitle');   titleEl.textContent = title;
    const frame     = document.getElementById('pdfFrame');
    const pdfRoot   = document.getElementById('pdfRoot');
    const loadingEl = document.getElementById('loading');
    const loadingMsg= document.getElementById('loadingMsg');
    const zoomBar   = document.getElementById('zoomBar');
    const zoomPctEl = document.getElementById('zoomPct');
    const btnIn     = document.getElementById('zoomIn');
    const btnOut    = document.getElementById('zoomOut');
    const btnFit    = document.getElementById('zoomFit');

    // CONFIG
    const DRIVE_PDF_URL = "https://drivepdf-vqmkygi2rq-uc.a.run.app"; // ganti jika berubah
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.matchMedia?.('(pointer:coarse)').matches;

    const withViewerPrefs = (url) =>
      url + '#page=1&zoom=page-width&view=FitH&toolbar=0&navpanes=0&scrollbar=0&statusbar=0&messages=0&sidebar=0';
    const isSafeURL = (u) => { try { const x=new URL(u,location.href); return /^https?:$/i.test(x.protocol); } catch { return false; } };
    const startLoading = (m='Memuat dokumen…') => { loadingMsg.textContent=m; loadingEl.hidden=false; };
    const stopLoading  = () => { loadingEl.hidden=true; };

    frame.addEventListener('load', () => stopLoading());

    // ====== pdf.js loader (ESM + fallback UMD) ======
    async function loadPdfJs() {
      const ver = '3.11.174';
      try {
        const mod = await import(`https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.min.mjs`);
        mod.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.worker.min.mjs`;
        return mod;
      } catch {
        await new Promise((ok, err) => { const s=document.createElement('script'); s.src=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.min.js`; s.onload=ok; s.onerror=err; document.head.appendChild(s); });
        await new Promise((ok, err) => { const s=document.createElement('script'); s.src=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.worker.min.js`; s.onload=ok; s.onerror=err; document.head.appendChild(s); });
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.worker.min.js`;
        return window.pdfjsLib;
      }
    }

    // ====== STATE untuk zoom rendering ======
    let pdfjs, pdfDoc, pages = [];
    let baseScale = 1;        // skala agar pas-lebar (CSS)
    let scale = 1;            // faktor zoom user
    const DPR_MAX = 2.5;      // batasi DPI
    const dpr = Math.min(window.devicePixelRatio || 1, DPR_MAX);

    function updateZoomLabel(){ zoomPctEl.textContent = Math.round(scale*100) + '%'; }

    async function renderPage(i){
      const page = await pdfDoc.getPage(i);
      const vw = page.getViewport({ scale: 1 });

      const cssW = Math.max(320, pdfRoot.clientWidth - 16);
      baseScale  = cssW / vw.width;                  // fit width
      const cssScale = baseScale * scale;            // total skala CSS
      const vp  = page.getViewport({ scale: cssScale });

      // Canvas & context
      let holder = pages[i];
      if (!holder) { holder = pages[i] = {}; }
      if (!holder.canvas) {
        holder.canvas = document.createElement('canvas');
        holder.canvas.className = 'pdf-page';
        pdfRoot.appendChild(holder.canvas);
      }
      const canvas = holder.canvas;
      canvas.style.width  = `${vp.width}px`;
      canvas.style.height = `${vp.height}px`;
      canvas.width  = Math.floor(vp.width  * dpr);
      canvas.height = Math.floor(vp.height * dpr);

      const ctx = canvas.getContext('2d', { alpha:false });
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      await page.render({ canvasContext: ctx, viewport: vp }).promise;
    }

    async function renderAllPages(){
      pdfRoot.innerHTML = ''; pages = [];
      for (let i = 1; i <= pdfDoc.numPages; i++){
        await renderPage(i);
      }
      stopLoading();
      zoomBar.hidden = false;     // tampilkan toolbar zoom setelah render pertama
      updateZoomLabel();
    }

    async function setScale(newScale){
      scale = Math.max(0.5, Math.min(newScale, 3)); // clamp
      startLoading('Mengatur zoom…');
      await renderAllPages();
    }

    // Resize/orientasi → render ulang pada lebar baru
    let resizeTimer;
    window.addEventListener('resize', () => {
      if (!pdfDoc || pdfRoot.hidden) return;
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => setScale(scale), 150);
    });

    // ====== Main flow ======
    onAuthStateChanged(auth, async (u) => {
      if (!u) { location.href = "./login.html"; return; }

      try {
        if (key) {
          startLoading(isMobile ? 'Merender SOP…' : 'Memuat SOP dari Drive…');
          const idToken = await u.getIdToken(true);
          const res = await fetch(`${DRIVE_PDF_URL}?key=${encodeURIComponent(key)}`, {
            headers: { Authorization: `Bearer ${idToken}` }
          });
          if (!res.ok) {
            const msg = await res.text().catch(()=>"");
            stopLoading();
            frame.srcdoc = `<!doctype html><meta charset="utf-8">
              <body style="background:#0b141a;color:#e9edef;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100%;text-align:center;padding:16px;">
                <div><h3>Terjadi kesalahan</h3><p>Status: ${res.status}</p>
                <pre style="white-space:pre-wrap;text-align:left">${msg}</pre>
                <p><a href="chatbot.html" style="color:#06cf9c;text-decoration:none;">Kembali</a></p></div>
  <script type="module" src="offline.js"></script>
              </body>`;
            return;
          }
          const blob = await res.blob();

          if (isMobile) {
            // pdf.js mode
            pdfjs = await loadPdfJs();
            frame.style.display = 'none';
            pdfRoot.hidden = false;
            const data = await blob.arrayBuffer();
            pdfDoc = await pdfjs.getDocument({ data }).promise;
            scale = 1; // mulai dari Fit width
            await renderAllPages();
          } else {
            // desktop iframe
            const url = URL.createObjectURL(blob);
            frame.src = withViewerPrefs(url);
            frame.addEventListener('load', () => setTimeout(() => URL.revokeObjectURL(url), 2000), { once:true });
          }

        } else if (isSafeURL(src)) {
          startLoading('Memuat dokumen…');
          frame.src = withViewerPrefs(src);
        } else {
          stopLoading();
          frame.srcdoc = `<!doctype html><meta charset="utf-8">
            <body style="background:#0b141a;color:#e9edef;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100%;text-align:center;padding:16px;">
              <div><h3>PDF tidak tersedia</h3>
              <p>Param <code>key</code> kosong dan <code>src</code> tidak valid.</p>
              <p><a href="chatbot.html" style="color:#06cf9c;text-decoration:none;">Kembali</a></p></div>
  <script type="module" src="offline.js"></script>
            </body>`;
        }
      } catch (e) {
        stopLoading();
        frame.srcdoc = `<!doctype html><meta charset="utf-8">
          <body style="background:#0b141a;color:#e9edef;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100%;text-align:center;padding:16px;">
            <div><h3>Terjadi kesalahan</h3>
            <pre style="white-space:pre-wrap;text-align:left">${String(e?.message||e)}</pre>
            <p><a href="chatbot.html" style="color:#06cf9c;text-decoration:none;">Kembali</a></p></div>
  <script type="module" src="offline.js"></script>
          </body>`;
      }
    });

    // ZOOM controls
    btnIn.addEventListener('click',  () => setScale(scale * 1.2));
    btnOut.addEventListener('click', () => setScale(scale / 1.2));
    btnFit.addEventListener('click', () => setScale(1));

    // Proteksi ringan
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("dragstart", e => e.preventDefault());
    document.addEventListener("keydown", e => {
      const k = e.key.toLowerCase(), ctrl = e.ctrlKey || e.metaKey;
      if (k === 'f12' || (ctrl && (k === 's' || k === 'p' || k === 'u' || k === 'c')) || (ctrl && e.shiftKey && (k === 'i' || k === 'j'))) {
        e.preventDefault(); e.stopPropagation();
      }
    }, { capture: true });
    document.addEventListener('selectstart', e => e.preventDefault(), { capture: true });
  </script>
  <script type="module" src="offline.js"></script>
  <script src="back.js"></script>
</body>
</html>
