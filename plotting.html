<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plotting</title>
  <link rel="stylesheet" href="plotting.css" />
  <style>
    html{visibility:hidden}        /* ditampilkan kembali oleh plotting.js */
    .hidden{display:none!important}/* untuk toggle assign/manage */
  </style>
</head>
<body>

  <!-- App Bar -->
  <header class="app-bar" role="banner">
    <a href="home.html" class="back-btn" aria-label="Kembali ke Home">
      <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26"
           viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </a>
    <h1 class="app-title">Plotting Tugas</h1>
  </header>

  <!-- Kartu Jam & Next Rotation -->
  <div class="header-card">
    <div class="header-top">
      <span id="connDot" class="conn-dot" aria-hidden="true"></span>
    </div>
    <div id="clock" class="clock">00:00:00</div>
    <div class="next-info">Perputaran selanjutnya <span id="nextRotation">-</span></div>
  </div>

  <!-- Tombol Lokasi -->
  <div class="site-bar">
    <button id="pscpBtn"  class="site-btn stop">PSCP</button>
    <button id="hbscpBtn" class="site-btn stop">HBSCP</button>
  </div>

  <!-- Kontrol Rotasi -->
  <div class="controls">
    <button id="startBtn" class="start">Mulai Rotasi</button>
    <button id="stopBtn"  class="stop" disabled>Hentikan</button>
    <button id="nextBtn"  disabled>Majukan 1x</button>

    <!-- Tombol Download PDF (dinamis mengikuti lokasi aktif) -->
    <button id="downloadPdfBtn" class="download" disabled>ðŸ“„ Download PDF</button>
  </div>

  <!-- Tabel penugasan -->
  <table class="assign hidden" aria-label="Tabel Penugasan">
    <thead>
      <tr><th>Posisi</th><th>Nama</th></tr>
    </thead>
    <tbody id="assignRows"></tbody>
  </table>

  <!-- Kelola Personil -->
  <div class="manage" aria-label="Kelola Personil">
    <h2>Kelola Personil</h2>
    <div class="add-person">
      <input id="nameInput" type="text" placeholder="Nama" />
      <label><input type="checkbox" id="seniorSpec" /> Senior</label>
      <label><input type="checkbox" id="juniorSpec" /> Junior</label>
      <label><input type="checkbox" id="basicSpec" /> Basic</label>
      <button id="addPersonBtn">Tambah</button>
    </div>

    <table class="people" aria-label="Daftar Personil">
      <thead>
        <tr><th>Nama</th><th>Senior</th><th>Junior</th><th>Basic</th><th>Aksi</th></tr>
      </thead>
      <tbody id="peopleRows"></tbody>
    </table>
  </div>

  <!-- Bottom Sheet (opsional) -->
  <div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
  <div id="bottomSheet" class="sheet hidden" role="dialog" aria-live="polite" aria-modal="true">
    <div class="sheet-header"><strong>Internet Connection</strong></div>
    <div id="sheetMsg" class="sheet-body"></div>
  </div>

  <!-- Auth guard: load SEBELUM plotting.js -->
  <script type="module">
    import { requireAuth } from "./auth-guard.js";
    requireAuth({ loginPath: "index.html", hideWhileChecking: true });
  </script>

  <!-- Plotting logic utama -->
  <script type="module" src="plotting.js"></script>

  <!-- Modul kecil untuk Download PDF dinamis (PSCP/HBSCP) -->
  <script type="module">
    // --- Sheet IDs (PSCP & HBSCP) ---
    const SHEETS = {
      pscp: {
        id: '1qOd-uWNGIguR4wTj85R5lQQF3GhTFnHru78scoTkux8', // Sheet ID PSCP
        gid: '0' // TODO: ganti dg gid tab PSCP
      },
      hbscp: {
        id: '1NwPi_H6W7SrCiXevy8y3uxovO2xKwlQKUryXM3q4iiU', // Sheet ID HBSCP
        gid: '0' // TODO: ganti dg gid tab HBSCP
      }
    };

    // Opsi default PDF export (bisa diubah sesuai kebutuhan)
    const PDF_DEFAULT_OPTS = {
      format: 'pdf',
      size: 'A4',
      portrait: 'true',
      scale: '2',               // 1=Normal, 2=Fit to width, 3=Fit to page
      top_margin: '0.50',
      bottom_margin: '0.50',
      left_margin: '0.50',
      right_margin: '0.50',
      sheetnames: 'false',
      printtitle: 'false',
      pagenumbers: 'true',
      gridlines: 'false',
      fzr: 'true'
    };

    function buildSheetPdfUrl(sheetId, gid, opts = {}) {
      const params = new URLSearchParams({ ...PDF_DEFAULT_OPTS, ...opts, gid });
      return `https://docs.google.com/spreadsheets/d/${sheetId}/export?${params.toString()}`;
    }

    const downloadBtn = document.getElementById('downloadPdfBtn');
    const pscpBtn     = document.getElementById('pscpBtn');
    const hbscpBtn    = document.getElementById('hbscpBtn');

    let currentSite = null;

    function setActiveSite(siteKey){
      currentSite = siteKey;
      if (downloadBtn) downloadBtn.disabled = false;
    }

    function openActiveSitePdf(){
      if (!currentSite || !SHEETS[currentSite]) {
        alert('Pilih lokasi dulu (PSCP / HBSCP).');
        return;
      }
      const { id, gid } = SHEETS[currentSite];
      const url = buildSheetPdfUrl(id, gid);
      window.open(url, '_blank');
    }

    // Pasang handler
    pscpBtn?.addEventListener('click',  () => setActiveSite('pscp'));
    hbscpBtn?.addEventListener('click', () => setActiveSite('hbscp'));
    downloadBtn?.addEventListener('click', openActiveSitePdf);
  </script>
</body>
</html>
