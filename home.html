<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Home</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101827;
      --text:#e5e7eb;
      --muted:#9aa3b2;
      --accent:#8b5cf6;      /* ungu */
      --accent-2:#6d28d9;    /* ungu gelap */
      --border:#1f2937;
      --radius:18px;
      --shadow:0 12px 24px rgba(0,0,0,.35);
      --safe-b: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0a0f1a 0%, #0b1220 40%, #0e1626 100%);
      color:var(--text); font:400 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Container ===== */
    .wrap{
      min-height:100dvh;
      display:flex; flex-direction:column;
      padding-bottom: calc(74px + var(--safe-b)); /* space for dock */
    }

    /* ===== Header (Profile + Greeting) ===== */
    .header{
      display:flex; align-items:center; gap:14px;
      padding:20px 16px 8px;
    }
    .avatar{
      width:64px; height:64px; border-radius:50%;
      background:#111a2a; border:1px solid var(--border);
      box-shadow: var(--shadow);
      object-fit:cover; flex:0 0 auto;
    }
    .hello{
      display:flex; flex-direction:column; gap:4px; min-width:0;
    }
    .greet{
      font-size:14px; color:var(--muted); letter-spacing:.2px;
    }
    .name{
      font-size:22px; font-weight:700; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
    }

    /* ===== Quick info card (optional tagline) ===== */
    .card{
      margin:12px 16px 8px; padding:14px 16px;
      background:rgba(16,24,39,.55);
      border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(6px);
      color:var(--muted);
    }

    /* ===== Apps Grid ===== */
    .apps{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(84px, 1fr));
      padding:10px 12px 16px;
    }
    .app{
      background:rgba(16,24,39,.55);
      border:1px solid var(--border);
      border-radius:16px; padding:12px 10px;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      text-align:center; text-decoration:none; color:var(--text);
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .app:active{ transform: scale(.98); }
    .app:hover{ background:rgba(16,24,39,.7); border-color:#243244; }
    .app-icon{
      width:36px; height:36px; border-radius:11px;
      display:grid; place-items:center; font-size:20px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 6px 14px rgba(107,33,168,.35);
    }
    .app-name{ font-size:12px; color:#dbe3f0 }

    /* ===== Bottom Dock ===== */
    .dock{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + var(--safe-b));
      background:rgba(10,15,26,.7);
      border-top:1px solid var(--border);
      backdrop-filter: blur(10px);
      z-index:50;
    }
    .dock-inner{
      height:54px; border-radius:16px; border:1px solid var(--border);
      display:grid; grid-template-columns: repeat(5, 1fr);
      gap:8px; padding:6px; background:rgba(16,24,39,.7);
      box-shadow: var(--shadow);
    }
    .dock-btn{
      display:grid; place-items:center;
      border-radius:12px; text-decoration:none; color:var(--text);
      font-size:20px; user-select:none;
      transition: background .2s ease, transform .12s ease;
    }
    .dock-btn:active{ transform:scale(.98); }
    .dock-btn:hover{ background:rgba(255,255,255,.06) }
    .dock-btn[aria-current="page"]{ outline:2px solid rgba(139,92,246,.5) }

    /* ===== Utilities ===== */
    .sr-only{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* ===== Responsive tweaks ===== */
    @media (min-width:768px){
      .header{ padding:24px 20px 8px }
      .apps{ padding:12px 16px 18px; gap:14px }
      .app{ padding:14px 12px; }
      .dock-inner{ max-width:760px; margin:0 auto; }
    }
  </style>
</head>
<body>
  <div class="wrap" role="application">
    <!-- Header -->
    <header class="header">
      <img id="avatar" class="avatar" alt="Foto pengguna" src="" />
      <div class="hello">
        <div id="greet" class="greet">Selamat datang</div>
        <div id="name" class="name">Pengguna</div>
      </div>
    </header>

    <!-- Optional small card -->
    <section class="card" id="tagline" aria-live="polite">
      Semoga harimu menyenangkan ‚ú®
    </section>

    <!-- Apps grid -->
    <main class="apps" id="apps" aria-label="Aplikasi">
      <!-- Contoh item aplikasi. Ganti href & label sesuai kebutuhan -->
      <a class="app" href="#chat" role="button">
        <div class="app-icon" aria-hidden="true">üí¨</div>
        <div class="app-name">Chat</div>
      </a>
      <a class="app" href="#video" role="button">
        <div class="app-icon" aria-hidden="true">üé•</div>
        <div class="app-name">Video Call</div>
      </a>
      <a class="app" href="#docs" role="button">
        <div class="app-icon" aria-hidden="true">üìÑ</div>
        <div class="app-name">Dokumen</div>
      </a>
      <a class="app" href="#schedule" role="button">
        <div class="app-icon" aria-hidden="true">üìÖ</div>
        <div class="app-name">Jadwal</div>
      </a>
      <a class="app" href="#gallery" role="button">
        <div class="app-icon" aria-hidden="true">üñºÔ∏è</div>
        <div class="app-name">Galeri</div>
      </a>
      <a class="app" href="#settings" role="button">
        <div class="app-icon" aria-hidden="true">‚öôÔ∏è</div>
        <div class="app-name">Pengaturan</div>
      </a>
    </main>
  </div>

  <!-- Bottom Dock -->
  <nav class="dock" aria-label="Menu bawah">
    <div class="dock-inner">
      <a class="dock-btn" href="#home" aria-current="page" title="Home">üè†<span class="sr-only">Home</span></a>
      <a class="dock-btn" href="#search" title="Cari">üîé<span class="sr-only">Cari</span></a>
      <a class="dock-btn" href="#scan" title="Scan">üì∑<span class="sr-only">Pindai</span></a>
      <a class="dock-btn" href="#notif" title="Notifikasi">üîî<span class="sr-only">Notifikasi</span></a>
      <a class="dock-btn" href="#profile" title="Profil">üë§<span class="sr-only">Profil</span></a>
    </div>
  </nav>

  <script>
    // ===== Utilities =====
    const $ = (sel, el=document) => el.querySelector(sel);
    const params = new URLSearchParams(location.search);

    // ===== Greeting logic (ID): pagi/siang/sore/malam =====
    function getGreetingID(date=new Date()){
      const h = date.getHours();
      if (h >= 4 && h < 11)  return "Selamat pagi";
      if (h >= 11 && h < 15) return "Selamat siang";
      if (h >= 15 && h < 18) return "Selamat sore";
      return "Selamat malam";
    }

    // ===== Data sources for name & photo =====
    // Prioritas:
    // 1) Data dari Kodular (via fungsi global setTinyData / postMessage)
    // 2) URL params ?name=... & ?photo=...
    // 3) localStorage (tinydb_name, tinydb_photo)
    function loadInitialData(){
      const nameFromURL = (params.get('name') || '').trim();
      const photoFromURL = (params.get('photo') || '').trim();

      const nameFromLS = localStorage.getItem('tinydb_name') || '';
      const photoFromLS = localStorage.getItem('tinydb_photo') || '';

      const name = nameFromURL || nameFromLS || 'Pengguna';
      const photo = photoFromURL || photoFromLS || '';

      applyProfile({ name, photo });
    }

    function applyProfile({name, photo}){
      if (name) {
        $("#name").textContent = name;
        localStorage.setItem('tinydb_name', name);
      }
      if (photo) {
        $("#avatar").src = photo;
        localStorage.setItem('tinydb_photo', photo);
      } else {
        // fallback avatar (initials)
        const n = (name || 'P U').trim();
        const initials = n.split(/\s+/).map(w=>w[0]).slice(0,2).join('').toUpperCase();
        // Make a simple initials avatar as data URL
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 256;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#111a2a';
        ctx.fillRect(0,0,256,256);
        ctx.fillStyle = '#8b5cf6';
        ctx.font = 'bold 120px system-ui';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(initials, 128, 140);
        $("#avatar").src = canvas.toDataURL('image/png');
      }
    }

    function updateGreeting(){
      $("#greet").textContent = getGreetingID();
    }

    // ===== Integrasi Kodular / TinyDB =====
    // Opsi A (paling simpel): dari Kodular, panggil Evaluate JavaScript:
    //   setTinyData({name: TinyDB.GetValue("nama"), photo: TinyDB.GetValue("fotoUrl")});
    // Opsi B: kirim postMessage dari WebViewer:
    //   WebViewer1.PostMessage( JSONTextEncode({type:"tinydb", name:"Budi", photo:"https://..."}) )
    // Opsi C: set WebViewString lalu Evaluate JS untuk membaca:
    //   WebViewer.WebViewString = JSONTextEncode({name:"Budi", photo:"..."});
    //   WebViewer.EvaluateJavaScript("readFromWebViewString()");
    window.setTinyData = function(obj){
      try{
        if (typeof obj === 'string') obj = JSON.parse(obj);
        const {name, photo} = obj || {};
        applyProfile({name, photo});
      }catch(e){ console.warn('TinyData parse error:', e); }
    };

    window.readFromWebViewString = function(){
      // Jika Kodular sudah mengisi document.title atau menyuntik JSON ke title/WebViewString via Evaluate JS,
      // kamu bisa override fungsi ini untuk ambil dari interface lain.
      // Secara default kita coba baca dari window.tinyWebString jika sudah diset sebelum ini dipanggil.
      try{
        if (window.tinyWebString){
          window.setTinyData(window.tinyWebString);
        }
      }catch(e){ console.warn(e); }
    };

    window.addEventListener('message', (ev)=>{
      // Terima pesan dari Kodular WebViewer.PostMessage (pastikan Allowed origins sesuai)
      try{
        const data = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
        if (data && (data.type === 'tinydb' || data.type === 'profile')) {
          applyProfile({name: data.name, photo: data.photo});
        }
      }catch(e){ /* ignore */ }
    });

    // ===== Init =====
    updateGreeting();                // set awal
    loadInitialData();               // tarik nama/foto awal
    setInterval(updateGreeting, 60 * 1000); // refresh tiap menit

    // Demo: jika ingin menambah/ubah item apps lewat JS
    // const apps = $("#apps");
    // apps.append(makeApp("üõ∞Ô∏è","Monitoring","#monitor"));

    function makeApp(icon, label, href="#"){
      const a = document.createElement('a');
      a.className = 'app'; a.href = href; a.role = 'button';
      a.innerHTML = `<div class="app-icon" aria-hidden="true">${icon}</div><div class="app-name">${label}</div>`;
      return a;
    }
  </script>
</body>
</html>
