<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kupon BBM — A4 Landscape (2 × 10cm + dashed guide)</title>
<style>
  :root{
    --frame:#1d9bf0; --ink:#0f172a; --paper:#ffffff;
    --stripe:#bbbfc4;

    --label-w:18mm; --colon-w:2mm; --row-gap:.7mm; --cell-font:7.8pt;
    --info-pad-v:2mm; --info-pad-h:2.6mm; --between-groups:6mm;

    /* warna & ketebalan dash (SVG) */
    --dash-color:#6b7280;
    --dash-stroke:1; /* px, non-scaling */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#f3f4f6; color:var(--ink);
    font:10pt Calibri,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-print-color-adjust:exact; print-color-adjust:exact; color-adjust:exact;
    -moz-print-color-adjust:exact;
  }

  /* A4 landscape */
  .page{
    width:297mm;height:210mm;margin:10mm auto;background:#fff;
    padding:10mm;position:relative;box-shadow:0 8px 30px rgba(0,0,0,.07)
  }

  /* Garis putus-putus vertikal di tengah (SVG) */
  .cutline{
    position:absolute; inset:8mm 0 8mm 0; pointer-events:none;
  }
  .cutline svg{position:absolute; left:50%; top:0; height:100%; transform:translateX(-50%);}
  .cutline .scissor{
    position:absolute; left:50%; top:0; transform:translate(-50%,-45%);
    font-size:11pt; line-height:1; color:#374151; background:#ffffff; padding:0 .8mm;
  }

  .halves{
    display:grid; grid-template-columns:1fr 1fr; height:100%;
    align-items:center; justify-items:center; column-gap:22mm;
  }

  /* Pembungkus kupon + dashed keliling (SVG) */
  .coupon-wrap{
    width:120mm; height:120mm; position:relative;
    display:flex; align-items:center; justify-content:center; overflow:visible;
  }
  .wrap-dash{ position:absolute; inset:0; pointer-events:none; }
  .wrap-dash svg{width:100%; height:100%; display:block;}
  .wrap-dash .scissor{
    position:absolute; left:50%; top:0; transform:translate(-50%,-45%);
    font-size:11pt; line-height:1; color:#374151; background:#ffffff; padding:0 .8mm;
  }

  /* Kupon 10×10 cm */
  .coupon{
    width:100mm; height:100mm; border:3mm solid var(--frame); border-radius:3mm;
    display:grid; grid-template-rows:auto auto auto; padding:4mm; padding-bottom:8mm;
    overflow:hidden; position:relative;
  }

  /* Header */
  .title{text-align:center;font-weight:900;margin:1mm 0 .8mm;font-size:14.2pt;letter-spacing:.2pt}
  .sub{text-align:center;font-weight:800;margin:0 0 3.5mm;line-height:1.08;font-size:8.2pt}
  .sub small{display:block;font-weight:800}

  /* Card info (abu-abu) */
  .info-card{background:var(--stripe);border-radius:3mm;padding:var(--info-pad-v) var(--info-pad-h);width:100%;align-self:start;margin:0 auto}
  .infotab{width:100%;border-collapse:separate;border-spacing:0 var(--row-gap)}
  .infotab td{padding:0;font-size:var(--cell-font);line-height:1;vertical-align:baseline}
  .lab{width:var(--label-w);font-weight:800}
  .colon{width:var(--colon-w)}
  .val{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .valL{padding-right:var(--between-groups)}

  /* Ringkasan putih */
  .summary{margin-top:3mm;background:#fff;border-radius:2.5mm;padding:2.2mm 3mm;text-align:center;font-weight:900;line-height:1.15;border:.2mm solid #e5e7eb}
  .summary .line1{text-transform:uppercase;font-size:8.5pt}
  .summary .line2{text-transform:uppercase;font-size:8.7pt;margin-top:1.2mm}

  /* Tanda tangan */
  .sign{text-align:center;line-height:1.2;font-size:8.2pt;margin-top:3mm}
  .org{font-weight:900}
  .role{font-weight:900;margin-top:.9mm}
  .sigline{width:72%;border-top:.3mm solid #111;margin:25mm auto 0}
  .namehint{
    font-size:10pt;
    color:#374151;
    margin-top:1.2mm;   /* rapat dengan garis */
    margin-bottom:2mm;  /* tidak nempel ke border kupon */
    font-weight:900;
  }

  /* Spinner overlay */
  .loading{
    position:absolute; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center; gap:8px;
    background:rgba(255,255,255,.65); backdrop-filter:saturate(1.2) blur(1px);
    z-index:5;
  }
  .spinner{
    width:22px; height:22px; border:3px solid #cbd5e1; border-top-color:#2563eb;
    border-radius:50%; animation:spin 0.8s linear infinite;
  }
  .loading-text{font-size:9pt; color:#334155; font-weight:700; letter-spacing:.2px}
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .coupon.is-ready .loading{ display:none; }

  /* Cetak 1 halaman */
  @page { size: A4 landscape; margin: 0 }
  @media print{
    body { background: transparent; }
    .page{ margin:0; box-shadow:none; height:210mm; padding:10mm; }
    .loading{ display:none !important; }
  }

  .msg{padding:18px;font:14px system-ui}
</style>
<style>html{visibility:hidden}</style>
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="icons/favicon-48.png">
  <link rel="icon" type="image/png" sizes="64x64" href="icons/favicon-64.png">
  <link rel="icon" type="image/png" sizes="128x128" href="icons/favicon-128.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/favicon-192.png">
  <link rel="icon" type="image/png" sizes="256x256" href="icons/favicon-256.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/favicon-512.png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="manifest" href="manifest.json" type="application/manifest+json">
</head>
<body>
  <div class="page" id="page">
    <!-- Garis putus-putus tengah (SVG, rapat) -->
    <div class="cutline" aria-hidden="true">
      <svg viewBox="0 0 1 1000" preserveAspectRatio="none">
        <line x1="0.5" y1="0" x2="0.5" y2="1000"
              stroke="var(--dash-color)"
              stroke-width="var(--dash-stroke)"
              vector-effect="non-scaling-stroke"
              stroke-dasharray="4 3" />
      </svg>
      <div class="scissor">✂</div>
    </div>

    <div class="halves">
      <!-- Kupon kiri -->
      <div class="coupon-wrap">
        <!-- dashed keliling (SVG, rapat) -->
        <div class="wrap-dash" aria-hidden="true">
          <svg viewBox="0 0 100 100" preserveAspectRatio="none">
            <rect x="0.75" y="0.75" width="98.5" height="98.5"
                  fill="none"
                  stroke="var(--dash-color)"
                  stroke-width="var(--dash-stroke)"
                  vector-effect="non-scaling-stroke"
                  stroke-dasharray="4 3"/>
          </svg>
          <div class="scissor">✂</div>
        </div>

        <section class="coupon">
          <div>
            <h2 class="title">KUPON BBM</h2>
            <p class="sub">PT ANGKASA PURA INDONESIA<small>KANTOR CABANG BANDARA BANYUWANGI</small></p>
          </div>

          <div class="info-card">
            <table class="infotab" role="presentation">
              <tr>
                <td class="lab">KODE</td><td class="colon">:</td>
                <td class="val valL" colspan="4" data-field="kode">—</td>
              </tr>
              <tr>
                <td class="lab">KEPERLUAN</td><td class="colon">:</td>
                <td class="val valL" colspan="4" data-field="keperluan">—</td>
              </tr>
              <tr>
                <td class="lab">TANGGAL</td><td class="colon">:</td>
                <td class="val valL" data-field="tanggal">—</td>
                <td class="lab">UNIT</td><td class="colon">:</td>
                <td class="val" data-field="unit">—</td>
              </tr>
            </table>

            <div class="summary">
              <div class="line1">JENIS <span data-field="jenis">—</span> &nbsp; JUMLAH <span data-field="jumlah">—</span></div>
              <div class="line2">TOTAL HARGA <span data-field="harga">—</span></div>
            </div>
          </div>

          <div class="sign">
            <div class="org" data-field="org">AIRPORT SECURITY, RESCUE &amp; FIRE FIGHTING</div>
            <div class="role">DEPARTEMENT HEAD</div>
            <div class="sigline"></div>
            <div class="namehint" data-field="signer">(Nama Jelas &amp; NIP)</div>
          </div>

          <div class="loading" aria-hidden="true">
            <div class="spinner"></div>
            <div class="loading-text">Memuat data…</div>
          </div>
        </section>
      </div>

      <!-- Kupon kanan -->
      <div class="coupon-wrap">
        <div class="wrap-dash" aria-hidden="true">
          <svg viewBox="0 0 100 100" preserveAspectRatio="none">
            <rect x="0.75" y="0.75" width="98.5" height="98.5"
                  fill="none"
                  stroke="var(--dash-color)"
                  stroke-width="var(--dash-stroke)"
                  vector-effect="non-scaling-stroke"
                  stroke-dasharray="4 3"/>
          </svg>
          <div class="scissor">✂</div>
        </div>

        <section class="coupon">
          <div>
            <h2 class="title">KUPON BBM</h2>
            <p class="sub">PT ANGKASA PURA INDONESIA<small>KANTOR CABANG BANDARA BANYUWANGI</small></p>
          </div>

          <div class="info-card">
            <table class="infotab" role="presentation">
              <tr>
                <td class="lab">KODE</td><td class="colon">:</td>
                <td class="val valL" colspan="4" data-field="kode">—</td>
              </tr>
              <tr>
                <td class="lab">KEPERLUAN</td><td class="colon">:</td>
                <td class="val valL" colspan="4" data-field="keperluan">—</td>
              </tr>
              <tr>
                <td class="lab">TANGGAL</td><td class="colon">:</td>
                <td class="val valL" data-field="tanggal">—</td>
                <td class="lab">UNIT</td><td class="colon">:</td>
                <td class="val" data-field="unit">—</td>
              </tr>
            </table>

            <div class="summary">
              <div class="line1">JENIS <span data-field="jenis">—</span> &nbsp; JUMLAH <span data-field="jumlah">—</span></div>
              <div class="line2">TOTAL HARGA <span data-field="harga">—</span></div>
            </div>
          </div>

          <div class="sign">
            <div class="org" data-field="org">AIRPORT SECURITY, RESCUE &amp; FIRE FIGHTING</div>
            <div class="role">DEPARTEMENT HEAD</div>
            <div class="sigline"></div>
            <div class="namehint" data-field="signer">(Nama Jelas &amp; NIP)</div>
          </div>

          <div class="loading" aria-hidden="true">
            <div class="spinner"></div>
            <div class="loading-text">Memuat data…</div>
          </div>
        </section>
      </div>

    </div>
  </div>

<div id="status" class="msg" hidden></div>

<script type="module">
import { requireAuth } from "./auth-guard.js";
requireAuth({ loginPath: "index.html", hideWhileChecking: true });
</script>

<script>
/* ===== Konfigurasi ===== */
const WORKER = "https://fuel.avsecbwx2018.workers.dev/";
const TOKEN  = "N45p";

/* ===== Util ===== */
function setField(name, value){
  document.querySelectorAll(`[data-field="${name}"]`).forEach(el => el.textContent = value);
}
function rupiah(n){ return (Math.round(Number(n)||0)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
function showMsg(txt){
  const el = document.getElementById('status');
  el.hidden = false;
  el.textContent = txt;
  document.getElementById('page').style.display = 'none';
}

/* ===== Main ===== */
(async () => {
  const id = new URLSearchParams(location.search).get('id') || '';
  if (!id) return showMsg("ID tidak diberikan di URL.");

  try {
    const res = await fetch(`${WORKER}?action=coupondata&id=${encodeURIComponent(id)}&token=${encodeURIComponent(TOKEN)}`, {
      method: "GET",
      headers: { "Accept": "application/json" }
    });
    const data = await res.json();

    if (!data || !data.ok) {
      return showMsg(data && data.error ? data.error : "Gagal memuat data kupon.");
    }

    const d = data.data;

    setField('kode', d.id);
    setField('unit', String(d.unit||'').toUpperCase());
    setField('tanggal', d.tanggal);
    setField('keperluan', String(d.keperluan||'').toUpperCase());
    setField('jenis', String(d.jenis||'').toUpperCase());
    setField('jumlah', `${d.liter} LITER`);
    setField('harga', `Rp. ${rupiah(d.harga)}`);
    setField('signer', d.signer || '(Nama Jelas & NIP)');
    setField('org', d.org || '');  // <<— label/jabatan dari sheet

    /* nama file default PDF mengikuti kode */
    document.title = `Kupon BBM — ${d.id}`;

    /* sembunyikan spinner pada kedua kupon */
    document.querySelectorAll('.coupon').forEach(el => el.classList.add('is-ready'));

    // tampilkan halaman + auto print
    document.getElementById('page').style.display = '';
    document.getElementById('status').hidden = true;

    setTimeout(()=>window.print(), 120);

  } catch (e) {
    showMsg("Gagal memuat: " + e);
  }
})();
</script>
  <script type="module" src="offline.js"></script>
</body>
</html>
